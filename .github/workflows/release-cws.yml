name: Release to Chrome Web Store

on:
  push:
    tags:
      - "v*"

concurrency:
  group: release-cws-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Validate release ref and main ancestry
        run: |
          if [[ ! "${GITHUB_REF_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Tag must match vX.Y.Z format."
            exit 1
          fi

          git fetch --no-tags origin main
          if ! git merge-base --is-ancestor "${GITHUB_SHA}" "origin/main"; then
            echo "Tagged commit is not contained in origin/main."
            exit 1
          fi

      - name: Validate tag and manifest version
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          MANIFEST_VERSION="$(node -p "JSON.parse(require('fs').readFileSync('manifest.json','utf8')).version")"
          echo "tag=${TAG_VERSION}"
          echo "manifest=${MANIFEST_VERSION}"
          if [ "${TAG_VERSION}" != "${MANIFEST_VERSION}" ]; then
            echo "Tag version and manifest version are different."
            exit 1
          fi

      - name: Build extension zip
        run: |
          chmod +x scripts/build_extension_zip.sh
          ZIP_PATH="dist/ai-content-screener-${GITHUB_REF_NAME}.zip"
          scripts/build_extension_zip.sh "${ZIP_PATH}"
          echo "ZIP_PATH=${ZIP_PATH}" >> "${GITHUB_ENV}"

      - name: Get OAuth access token
        env:
          CWS_CLIENT_ID: ${{ secrets.CWS_CLIENT_ID }}
          CWS_CLIENT_SECRET: ${{ secrets.CWS_CLIENT_SECRET }}
          CWS_REFRESH_TOKEN: ${{ secrets.CWS_REFRESH_TOKEN }}
        run: |
          curl -sS -X POST "https://oauth2.googleapis.com/token" \
            -d "client_id=${CWS_CLIENT_ID}" \
            -d "client_secret=${CWS_CLIENT_SECRET}" \
            -d "refresh_token=${CWS_REFRESH_TOKEN}" \
            -d "grant_type=refresh_token" \
            > token_response.json

          ACCESS_TOKEN="$(python3 - <<'PY'
          import json
          from pathlib import Path

          payload = json.loads(Path("token_response.json").read_text(encoding="utf-8"))
          token = payload.get("access_token")
          if not token:
            raise SystemExit(f"Failed to get access token: {payload}")
          print(token)
          PY
          )"
          echo "::add-mask::${ACCESS_TOKEN}"
          echo "ACCESS_TOKEN=${ACCESS_TOKEN}" >> "${GITHUB_ENV}"

      - name: Upload package to Chrome Web Store
        env:
          ACCESS_TOKEN: ${{ env.ACCESS_TOKEN }}
          CWS_PUBLISHER_ID: ${{ secrets.CWS_PUBLISHER_ID }}
          CWS_EXTENSION_ID: ${{ secrets.CWS_EXTENSION_ID }}
          ZIP_PATH: ${{ env.ZIP_PATH }}
        run: |
          HTTP_CODE="$(curl -sS -o upload_response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/zip" \
            --data-binary "@${ZIP_PATH}" \
            "https://chromewebstore.googleapis.com/upload/v2/publishers/${CWS_PUBLISHER_ID}/items/${CWS_EXTENSION_ID}:upload")"

          python3 -m json.tool upload_response.json || cat upload_response.json
          if [ "${HTTP_CODE}" -lt 200 ] || [ "${HTTP_CODE}" -ge 300 ]; then
            echo "Upload failed with HTTP ${HTTP_CODE}"
            exit 1
          fi

      - name: Publish package
        env:
          ACCESS_TOKEN: ${{ env.ACCESS_TOKEN }}
          CWS_PUBLISHER_ID: ${{ secrets.CWS_PUBLISHER_ID }}
          CWS_EXTENSION_ID: ${{ secrets.CWS_EXTENSION_ID }}
        run: |
          HTTP_CODE="$(curl -sS -o publish_response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://chromewebstore.googleapis.com/v2/publishers/${CWS_PUBLISHER_ID}/items/${CWS_EXTENSION_ID}:publish")"

          python3 -m json.tool publish_response.json || cat publish_response.json
          if [ "${HTTP_CODE}" -lt 200 ] || [ "${HTTP_CODE}" -ge 300 ]; then
            echo "Publish failed with HTTP ${HTTP_CODE}"
            exit 1
          fi
